<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>VRC Ladder Rankings - Home</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="custom.css">
    <link rel="stylesheet" href="auth.css">
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>

<body>
    <!-- Navigation Bar with Search Button -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="index.html">VRC Ladder Rankings</a>
        <div class="ml-auto">
            <a href="search.html" class="btn btn-outline-light">Search for a Player</a>
        </div>
    </nav>

    <div class="container mt-4" id="authContainer">
        <!-- Authentication prompt will be injected here -->
    </div>
    <div class="container mt-4 requires-auth">
        <!-- Display Last Update Times -->
        <div class="content-section">
            <h1>Welcome to the VRC Ladder Rankings</h1>
            <p class="lead">Below are the top players in each category.</p>
            <div id="lastUpdate" class="text-muted"></div>
        </div>

        <!-- Singles Section -->
        <div class="content-section">
            <h2>Singles Ladder - Top 5 <a href="ladder.html?ladder=singles" class="btn btn-sm btn-outline-secondary ml-2">View full ranking</a></h2>
            <div id="singlesResults"></div>
        </div>

        <!-- Doubles Section -->
        <div class="content-section">
            <h2>Doubles Ladder - Top 5 <a href="ladder.html?ladder=doubles" class="btn btn-sm btn-outline-secondary ml-2">View full ranking</a></h2>
            <div id="doublesResults"></div>
        </div>

        <!-- Mixed Section -->
        <div class="content-section">
            <h2>Mixed Ladder (Pairs) - Top 5 <a href="ladder.html?ladder=mixed" class="btn btn-sm btn-outline-secondary ml-2">View full ranking</a></h2>
            <div id="mixedResults"></div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        // --- Display Last Update Times ---
        fetch('last_timestamps.json')
            .then(response => response.json())
            .then(data => {
                const lastUpdateDiv = document.getElementById('lastUpdate');
                lastUpdateDiv.innerHTML = `<strong>Last Data Refresh:</strong>
          Singles: ${data.singles || 'N/A'}, 
          Doubles: ${data.doubles || 'N/A'}, 
          Mixed: ${data.mixed || 'N/A'}`;
            })
            .catch(err => {
                console.error("Error loading last_timestamps.json", err);
            });

        // --- Helper: Sort by Position (ascending) ---
        function sortByPosition(a, b) {
            return parseInt(a.Position, 10) - parseInt(b.Position, 10);
        }

        // --- Render Table for Singles and Doubles (without Last Update column) ---
        function renderStandardTable(dataArray) {
            let html = '<table class="table table-striped"><thead><tr>' +
                '<th>Position</th><th>Name</th></tr></thead><tbody>';
            dataArray.forEach(row => {
                let fullName = row.FirstName + " " + row.LastName;
                html += `<tr>
                   <td>${row.Position}</td>
                   <td><a href="player.html?player_id=${row.PlayerID}">${fullName}</a></td>
                 </tr>`;
            });
            html += '</tbody></table>';
            return html;
        }

        // --- Render Table for Mixed Pairs (without Last Update column) ---
        function renderMixedTable(dataArray) {
            let html = '<table class="table table-striped"><thead><tr>' +
                '<th>Position</th><th>Pair ID</th><th>Team</th></tr></thead><tbody>';
            dataArray.forEach(row => {
                let p1Link = `<a href="player.html?player_id=${row.P1_ID}">${row.P1_FirstName} ${row.P1_LastName}</a>`;
                let p2Link = `<a href="player.html?player_id=${row.P2_ID}">${row.P2_FirstName} ${row.P2_LastName}</a>`;
                let teamName = p1Link + " / " + p2Link;
                html += `<tr>
                   <td>${row.Position}</td>
                   <td>${row.PairID}</td>
                   <td>${teamName}</td>
                 </tr>`;
            });
            html += '</tbody></table>';
            return html;
        }

        // --- Load and Render the Singles CSV File ---
        Papa.parse('latest_singles.csv', {
            download: true,
            header: true,
            complete: function (results) {
                let singles = results.data;
                singles.sort(sortByPosition);
                singles = singles.slice(0, 5);
                document.getElementById('singlesResults').innerHTML = renderStandardTable(singles);
            },
            error: function (err) {
                console.error("Error loading latest_singles.csv", err);
            }
        });

        // --- Load and Render the Doubles CSV File ---
        Papa.parse('latest_doubles.csv', {
            download: true,
            header: true,
            complete: function (results) {
                let doubles = results.data;
                doubles.sort(sortByPosition);
                doubles = doubles.slice(0, 5);
                document.getElementById('doublesResults').innerHTML = renderStandardTable(doubles);
            },
            error: function (err) {
                console.error("Error loading latest_doubles.csv", err);
            }
        });

        // --- Load and Render the Mixed CSV File ---
        Papa.parse('latest_mixed.csv', {
            download: true,
            header: true,
            complete: function (results) {
                let mixed = results.data;
                mixed.sort(sortByPosition);
                mixed = mixed.slice(0, 5);
                document.getElementById('mixedResults').innerHTML = renderMixedTable(mixed);
            },
            error: function (err) {
                console.error("Error loading latest_mixed.csv", err);
            }
        });

        // --- Authentication Check ---
        document.addEventListener('DOMContentLoaded', async () => {
            const isAuthenticated = sessionStorage.getItem('vrc_authenticated') === 'true';
            const email = sessionStorage.getItem('vrc_email');
            const password = sessionStorage.getItem('vrc_password');

            if (isAuthenticated && email && password) {
                if (await vrcLogin(email, password)) {
                    showPageContent();
                    return;
                }
            }
            showLoginPrompt();
        });
    </script>
</body>

</html>